<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FactoryOne - Master Edition v3.0</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè≠</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] } } }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* Interactive Elements */
        .sort-header { cursor: pointer; user-select: none; transition: color 0.2s; }
        .sort-header:hover { color: #3b82f6; }
        
        /* PRINT STYLES (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å) */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: white; }
            @page { size: auto; margin: 0mm; }
        }

        .label-card {
            width: 350px; height: 220px;
            border: 3px solid #000;
            padding: 15px;
            font-family: 'Inter', sans-serif;
            display: flex; gap: 15px;
            background: white; color: black;
            box-sizing: border-box;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans transition-colors duration-200 overflow-hidden selection:bg-blue-100 dark:selection:bg-blue-900">

    <div id="login-screen" class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center transition-opacity duration-500">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-2xl w-full max-w-md border border-slate-700/50 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-600 to-purple-600"></div>
            <div class="w-20 h-20 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-blue-500/50">
                <i class="fa-solid fa-industry text-4xl text-white"></i>
            </div>
            <h1 class="text-3xl font-extrabold text-slate-800 dark:text-white mb-2">FactoryOne</h1>
            <p class="text-slate-500 dark:text-slate-400 mb-8">Master Edition v3.0</p>
            
            <form onsubmit="event.preventDefault(); handleLogin();" class="space-y-4 text-left">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Username</label>
                    <input type="text" id="login-user" class="w-full px-4 py-3 rounded-xl border dark:border-slate-600 bg-slate-50 dark:bg-slate-700/50 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="Enter your name" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                    <input type="password" id="login-pass" class="w-full px-4 py-3 rounded-xl border dark:border-slate-600 bg-slate-50 dark:bg-slate-700/50 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="1234">
                </div>
                <button type="submit" class="w-full py-3.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 transition transform active:scale-95 mt-4">
                    Access System
                </button>
            </form>
            <p class="mt-6 text-xs text-slate-400">Default Pass: 1234</p>
        </div>
    </div>

    <div id="app-root" class="flex h-screen">
        <aside id="sidebar" class="bg-slate-900 text-white w-72 flex-shrink-0 flex flex-col transition-all duration-300 fixed md:static inset-y-0 left-0 z-50 transform -translate-x-full md:translate-x-0 shadow-2xl">
            <div class="h-20 flex items-center gap-3 px-6 border-b border-slate-800 bg-slate-900">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-blue-500 flex items-center justify-center shadow-lg shadow-blue-900/50">
                    <i class="fa-solid fa-cube text-xl text-white"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg tracking-wide">FactoryOne</h1>
                    <p class="text-xs text-slate-400">v3.0 Master</p>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto" id="nav-container"></nav>
            
            <div class="px-4 pb-2 space-y-2">
                <button onclick="backupSystem()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 text-green-400 hover:bg-green-500/10 hover:text-green-300 group border border-dashed border-green-500/30">
                    <i class="fa-solid fa-download w-5 text-center"></i> 
                    <span class="font-medium text-sm">Backup Data</span>
                </button>
                <label class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 text-blue-400 hover:bg-blue-500/10 hover:text-blue-300 group border border-dashed border-blue-400/30 cursor-pointer">
                    <i class="fa-solid fa-upload w-5 text-center"></i> 
                    <span class="font-medium text-sm">Restore Data</span>
                    <input type="file" id="restore-file" accept=".json" class="hidden" onchange="restoreSystem(this)">
                </label>
                <button onclick="factoryReset()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 text-red-400 hover:bg-red-500/10 hover:text-red-300 group">
                    <i class="fa-solid fa-power-off w-5 text-center group-hover:rotate-90 transition-transform"></i> 
                    <span class="font-medium text-sm">Reset System</span>
                </button>
            </div>
            
            <div class="p-4 border-t border-slate-800 bg-slate-900">
                <div class="flex items-center gap-3 p-3 bg-slate-800/50 rounded-xl border border-slate-700/50">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center font-bold text-sm shadow-md" id="user-avatar">US</div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-semibold truncate" id="user-name-display">Guest</p>
                        <p class="text-xs text-green-400 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span> Online</p>
                    </div>
                </div>
            </div>
        </aside>

        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

        <main class="flex-1 flex flex-col h-screen overflow-hidden relative w-full bg-slate-50 dark:bg-slate-900 transition-colors duration-200">
            <header class="h-20 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between px-6 lg:px-8 z-30 shadow-sm">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="md:hidden p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg transition"><i class="fa-solid fa-bars text-xl"></i></button>
                    <h2 id="page-title" class="text-2xl font-bold text-slate-800 dark:text-white tracking-tight">Dashboard</h2>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleDarkMode()" class="p-2.5 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition border border-transparent hover:border-slate-200 dark:hover:border-slate-600">
                        <i class="fa-solid fa-moon dark:hidden"></i>
                        <i class="fa-solid fa-sun hidden dark:inline text-yellow-400"></i>
                    </button>
                    <div class="relative group">
                        <button class="p-2.5 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition border border-transparent hover:border-slate-200 dark:hover:border-slate-600">
                            <i class="fa-solid fa-bell text-lg"></i>
                            <span class="absolute top-2 right-2.5 w-2 h-2 bg-red-500 rounded-full border-2 border-white dark:border-slate-800 animate-pulse"></span>
                        </button>
                    </div>
                </div>
            </header>

            <div id="content-area" class="flex-1 overflow-y-auto p-4 lg:p-8 relative scroll-smooth"></div>
        </main>
    </div>

    <div id="modal-form" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4 fade-in">
        <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-lg shadow-2xl scale-in overflow-hidden border border-slate-100 dark:border-slate-700 max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800 sticky top-0 z-10">
                <h3 id="modal-title" class="text-xl font-bold text-slate-800 dark:text-white">Item Details</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <form onsubmit="event.preventDefault(); handleFormSubmit();" class="p-6 space-y-5">
                <input type="hidden" id="inp-id">
                
                <div>
                    <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1.5">Image URL (Optional)</label>
                    <div class="flex gap-2">
                        <input type="text" id="inp-img" class="flex-1 px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="https://...">
                        <div class="w-12 h-12 rounded-lg bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 overflow-hidden flex items-center justify-center relative">
                             <img id="preview-img" src="" onerror="this.style.display='none'" class="w-full h-full object-cover hidden absolute inset-0">
                             <i id="preview-icon" class="fa-solid fa-image text-slate-400"></i>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1.5">Item Name</label>
                    <input type="text" id="inp-name" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="e.g. Steel Plate">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1.5">SKU (Barcode)</label>
                        <input type="text" id="inp-sku" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all font-mono" placeholder="SCAN or TYPE">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1.5">Location</label>
                        <input type="text" id="inp-loc" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="Zone A">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1.5">Stock</label>
                        <input type="number" id="inp-stock" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" value="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1.5">Min Level</label>
                        <input type="number" id="inp-min" required class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" value="10">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1.5">Unit</label>
                        <select id="inp-unit" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                            <option value="pcs">Pcs</option>
                            <option value="kg">Kg</option>
                            <option value="L">Liter</option>
                            <option value="box">Box</option>
                            <option value="roll">Roll</option>
                            <option value="set">Set</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-500 dark:text-slate-400 mb-1.5">Unit Cost (‡∏ø)</label>
                    <input type="number" id="inp-cost" class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="0.00" step="0.01">
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeModal()" class="flex-1 py-3 rounded-xl border border-slate-200 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition font-medium">Cancel</button>
                    <button type="submit" class="flex-1 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-medium shadow-lg shadow-blue-500/30 transition transform active:scale-95">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-reorder" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[80] hidden flex items-center justify-center p-4 fade-in">
        <div class="bg-white rounded-2xl w-full max-w-3xl shadow-2xl scale-in overflow-hidden h-[80vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center text-orange-600"><i class="fa-solid fa-clipboard-list"></i></div>
                    <div>
                        <h3 class="text-xl font-bold text-slate-800">Purchase Request</h3>
                        <p class="text-sm text-slate-500">Auto-generated based on Min Level</p>
                    </div>
                </div>
                <button onclick="document.getElementById('modal-reorder').classList.add('hidden')" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-8" id="reorder-content"></div>
            <div class="p-6 border-t bg-slate-50 flex justify-end gap-3">
                 <button onclick="printReorder()" class="px-6 py-3 bg-slate-900 text-white rounded-xl hover:bg-black transition flex items-center gap-2 shadow-lg">
                    <i class="fa-solid fa-print"></i> Print PO
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-6 right-6 z-[90] bg-white dark:bg-slate-800 border-l-4 border-green-500 pl-4 pr-6 py-4 rounded-lg shadow-2xl transform translate-x-[150%] transition-transform duration-500 flex items-center gap-4">
        <div class="bg-green-100 dark:bg-green-900/50 p-2 rounded-full text-green-600 dark:text-green-400"><i class="fa-solid fa-check"></i></div>
        <div>
            <h4 class="font-bold text-slate-800 dark:text-white text-sm" id="toast-title">Success</h4>
            <p id="toast-msg" class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">Operation completed.</p>
        </div>
    </div>

    <div id="print-area" class="hidden"></div>

    <script>
        // ==========================================
        // 1. DATA & CONFIG
        // ==========================================
        const defaultInv = [
            { id: 1, name: 'Steel Plate A4', sku: 'STL-A4', stock: 45, min: 50, unit: 'pcs', loc: 'Zone A', cost: 150, img: '' },
            { id: 2, name: 'Hydraulic Oil', sku: 'OIL-15W', stock: 120, min: 30, unit: 'L', loc: 'Zone B', cost: 80, img: '' },
        ];
        
        let inventory = JSON.parse(localStorage.getItem('factory_inv_v3')) || defaultInv;
        let activityLogs = JSON.parse(localStorage.getItem('factory_logs_v3')) || [];
        let transactionHistory = JSON.parse(localStorage.getItem('factory_trans_v3')) || [];
        
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let currentUser = 'Guest';
        let filterStatus = 'all';
        let sortConfig = { key: 'id', direction: 'desc' };

        // USB Scanner Buffer
        let scanBuffer = "";
        let scanTime = Date.now();

        // ==========================================
        // 2. AUTH & INIT
        // ==========================================
        function handleLogin() {
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            
            if(p === '1234') {
                currentUser = u || 'Admin';
                document.getElementById('user-name-display').innerText = currentUser;
                document.getElementById('user-avatar').innerText = currentUser.substring(0,2).toUpperCase();
                
                const screen = document.getElementById('login-screen');
                screen.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => screen.remove(), 500);
                init();
            } else {
                alert('‚ùå Incorrect Password! (Default: 1234)');
            }
        }

        function init() {
            if(isDarkMode) document.documentElement.classList.add('dark');
            renderNav();
            router('dashboard');
            
            // Image Preview Listener
            document.getElementById('inp-img').addEventListener('input', function() {
                const val = this.value;
                const img = document.getElementById('preview-img');
                const icon = document.getElementById('preview-icon');
                if(val) { img.src = val; img.style.display='block'; img.classList.remove('hidden'); icon.style.display='none'; }
                else { img.style.display='none'; icon.style.display='block'; }
            });

            // Scanner Listener
            document.addEventListener("keydown", (e) => {
                if (e.target.tagName === 'INPUT') return;
                const char = e.key;
                const now = Date.now();
                if (now - scanTime > 50) scanBuffer = "";
                scanTime = now;
                if (char === "Enter") {
                    if (scanBuffer.length > 2) handleBarcodeScan(scanBuffer);
                    scanBuffer = "";
                } else if (char.length === 1) scanBuffer += char;
            });
        }

        // ==========================================
        // 3. ROUTING & UI
        // ==========================================
        const routes = [
            { id: 'dashboard', label: 'Dashboard', icon: 'fa-chart-pie' },
            { id: 'inventory', label: 'Inventory', icon: 'fa-boxes-stacked' },
            { id: 'history', label: 'History', icon: 'fa-clock-rotate-left' },
            { id: 'production', label: 'Production', icon: 'fa-industry' },
        ];
        let currRoute = 'dashboard';

        function renderNav() {
            document.getElementById('nav-container').innerHTML = routes.map(r => `
                <button onclick="router('${r.id}')" id="btn-${r.id}" class="w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-white group">
                    <i class="fa-solid ${r.icon} w-6 text-center group-hover:scale-110 transition-transform"></i> 
                    <span class="font-medium tracking-wide">${r.label}</span>
                </button>
            `).join('');
        }

        function router(id) {
            currRoute = id;
            document.querySelectorAll('nav button').forEach(b => b.className = "w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-200 text-slate-400 hover:bg-slate-800 hover:text-white group");
            document.getElementById(`btn-${id}`).className = "w-full flex items-center gap-4 px-4 py-3 rounded-xl transition-all duration-200 bg-blue-600 text-white shadow-lg shadow-blue-900/50 group";
            
            document.getElementById('sidebar-overlay').classList.add('hidden');
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar').classList.remove('translate-x-0');

            const container = document.getElementById('content-area');
            document.getElementById('page-title').innerText = routes.find(r=>r.id===id).label;
            
            if(id === 'dashboard') renderDashboard(container);
            else if(id === 'inventory') renderInventory(container);
            else if(id === 'history') renderHistory(container);
            else if(id === 'production') renderProduction(container);
        }

        // ==========================================
        // 4. RENDERERS (PAGES)
        // ==========================================
        
        // --- DASHBOARD ---
        function renderDashboard(el) {
            const lowStock = inventory.filter(i => i.stock < i.min).length;
            const totalVal = inventory.reduce((sum, i) => sum + (i.stock * (i.cost||0)), 0);
            const valStr = new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB', minimumFractionDigits:0 }).format(totalVal);
            
            const logRows = activityLogs.slice(0, 5).map(log => `
                <div class="flex items-start justify-between p-3 bg-slate-50 dark:bg-slate-700/30 rounded-lg">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 flex items-center justify-center text-xs"><i class="fa-solid fa-info"></i></div>
                        <div><p class="text-sm font-bold text-slate-700 dark:text-slate-200">${log.action}</p><p class="text-xs text-slate-500">${log.desc}</p></div>
                    </div>
                    <p class="text-xs font-mono text-slate-400">${log.time}</p>
                </div>
            `).join('');

            el.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 fade-in">
                    ${statCard('Total Items', inventory.length, 'SKUs', 'fa-box', 'blue')}
                    ${statCard('Inventory Value', valStr, 'Total Asset', 'fa-sack-dollar', 'green')}
                    ${statCard('Low Stock', lowStock, 'Alerts', 'fa-triangle-exclamation', 'orange')}
                    ${statCard('User Online', currentUser, 'Active', 'fa-user-clock', 'purple')}
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 fade-in">
                    <div class="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                         <h3 class="font-bold text-lg text-slate-700 dark:text-white mb-6">Stock Distribution</h3>
                         <div class="h-64"><canvas id="chartInv"></canvas></div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg text-slate-700 dark:text-white">Recent Logs</h3></div>
                        <div class="space-y-3">${logRows || '<p class="text-center text-slate-400">No activity</p>'}</div>
                    </div>
                </div>`;
            setTimeout(initCharts, 50);
        }

        // --- INVENTORY ---
        function renderInventory(el) {
            el.innerHTML = `
                <div class="space-y-6 fade-in">
                    <div class="flex flex-col xl:flex-row justify-between gap-4">
                        <div class="flex flex-col sm:flex-row gap-4 w-full xl:w-auto">
                            <div class="relative flex-1 sm:w-80 group">
                                <i class="fa-solid fa-search absolute left-4 top-3.5 text-slate-400"></i>
                                <input type="text" id="search" onkeyup="renderInvTable()" placeholder="Search Name or SKU..." class="w-full pl-11 pr-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none shadow-sm">
                            </div>
                            <select id="filter-status" onchange="filterStatus=this.value;renderInvTable()" class="w-full sm:w-48 px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                                <option value="all">All Status</option>
                                <option value="normal">‚úÖ Normal</option>
                                <option value="low">‚ö†Ô∏è Low Stock</option>
                                <option value="out">‚ùå Out of Stock</option>
                            </select>
                        </div>
                        <div class="flex gap-3 w-full xl:w-auto overflow-x-auto pb-2 xl:pb-0">
                            <button onclick="openReorderModal()" class="px-5 py-3 border border-orange-200 text-orange-600 bg-orange-50 rounded-xl hover:bg-orange-100 transition flex items-center gap-2 font-medium whitespace-nowrap">
                                <i class="fa-solid fa-clipboard-list"></i> Reorder
                            </button>
                            <button onclick="exportCSV()" class="px-5 py-3 border border-slate-200 text-slate-600 rounded-xl hover:bg-slate-50 transition flex items-center gap-2 font-medium whitespace-nowrap">
                                <i class="fa-solid fa-file-csv"></i> Export
                            </button>
                            <label class="px-5 py-3 border border-slate-200 text-slate-600 rounded-xl hover:bg-slate-50 transition flex items-center gap-2 font-medium cursor-pointer whitespace-nowrap">
                                <i class="fa-solid fa-file-import"></i> Import
                                <input type="file" accept=".csv" class="hidden" onchange="importCSV(this)">
                            </label>
                            <button onclick="openModal()" class="flex-1 sm:flex-none px-5 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-500/30 transition flex items-center justify-center gap-2 font-medium whitespace-nowrap">
                                <i class="fa-solid fa-plus"></i> Add Item
                            </button>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 dark:bg-slate-700/50 border-b border-slate-200 dark:border-slate-700">
                                    <tr>
                                        ${th('name', 'Product Info')}
                                        ${th('stock', 'Stock Level')}
                                        ${th('loc', 'Location')}
                                        <th class="px-6 py-4 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inv-body" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            renderInvTable();
        }

        // --- HISTORY ---
        function renderHistory(el) {
            const today = new Date().toISOString().slice(0, 7);
            el.innerHTML = `
                <div class="space-y-6 fade-in">
                    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 bg-white dark:bg-slate-800 p-5 rounded-2xl border border-slate-200 dark:border-slate-700 shadow-sm">
                        <div class="flex gap-4 w-full sm:w-auto">
                            <input type="month" id="hist-month" value="${today}" onchange="renderHistoryTable()" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white">
                            <select id="hist-type" onchange="renderHistoryTable()" class="px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white">
                                <option value="all">All Types</option>
                                <option value="IN">Stock IN</option>
                                <option value="OUT">Stock OUT</option>
                                <option value="NEW">New Item</option>
                                <option value="DELETE">Delete</option>
                            </select>
                        </div>
                        <div class="flex gap-6 text-right">
                            <div><p class="text-xs text-slate-400 uppercase font-bold">Total In</p><p class="text-xl font-bold text-green-500" id="sum-in">0</p></div>
                            <div class="border-l pl-6 border-slate-200"><p class="text-xs text-slate-400 uppercase font-bold">Total Out</p><p class="text-xl font-bold text-red-500" id="sum-out">0</p></div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                        <div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-slate-50 dark:bg-slate-700/50"><tr><th class="px-6 py-4">Time</th><th class="px-6 py-4">Type</th><th class="px-6 py-4">Item Detail</th><th class="px-6 py-4 text-right">Qty</th><th class="px-6 py-4 text-right">User</th></tr></thead><tbody id="hist-body" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody></table></div>
                    </div>
                </div>`;
            renderHistoryTable();
        }

        // --- PRODUCTION ---
        function renderProduction(el) {
             const m = (n,s,e,c) => `<div class="bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl p-6 flex items-center gap-6 shadow-sm"><div class="w-16 h-16 rounded-full bg-${c}-100 flex items-center justify-center text-2xl text-${c}-600 ${s==='Running'?'animate-pulse':''}"><i class="fa-solid fa-gears"></i></div><div class="flex-1"> <div class="flex justify-between mb-2"><h3 class="font-bold text-lg dark:text-white">${n}</h3><span class="px-3 py-1 rounded-full text-xs font-bold uppercase bg-${c}-100 text-${c}-700">${s}</span></div><div class="w-full bg-slate-100 h-2.5 rounded-full overflow-hidden"><div class="bg-${c}-500 h-2.5 rounded-full" style="width: ${e}%"></div></div><div class="flex justify-between mt-2 text-xs text-slate-500"><span>OEE: ${e}%</span></div></div></div>`;
             el.innerHTML = `<div class="space-y-6 fade-in"><h2 class="text-2xl font-bold dark:text-white mb-6">Production Monitor</h2><div class="grid gap-4">${m('CNC 01','Running',92,'green')}${m('Assembly Line','Running',88,'green')}${m('Packaging','Stopped',0,'red')}</div></div>`;
        }

        // ==========================================
        // 5. DATA LOGIC & TABLES
        // ==========================================
        function renderInvTable() {
            const term = document.getElementById('search')?.value.toLowerCase() || '';
            const tbody = document.getElementById('inv-body');
            
            let filtered = inventory.filter(i => {
                const text = i.name.toLowerCase().includes(term) || i.sku.toLowerCase().includes(term);
                if(filterStatus === 'low') return text && i.stock < i.min && i.stock > 0;
                if(filterStatus === 'out') return text && i.stock === 0;
                if(filterStatus === 'normal') return text && i.stock >= i.min;
                return text;
            });

            // Sort
            filtered.sort((a,b) => {
                let va = a[sortConfig.key], vb = b[sortConfig.key];
                if(typeof va === 'string') return sortConfig.direction==='asc' ? va.localeCompare(vb) : vb.localeCompare(va);
                return sortConfig.direction==='asc' ? va-vb : vb-va;
            });

            if(!filtered.length) { tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-slate-400">No items found.</td></tr>`; return; }

            tbody.innerHTML = filtered.map(i => `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30 transition group">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-lg bg-slate-100 dark:bg-slate-700 flex-shrink-0 overflow-hidden border border-slate-200 dark:border-slate-600">
                                ${i.img ? `<img src="${i.img}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-slate-400"><i class="fa-solid fa-box"></i></div>`}
                            </div>
                            <div>
                                <div class="font-bold text-slate-800 dark:text-white">${i.name}</div>
                                <div class="text-xs text-slate-400 font-mono">${i.sku}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                         <div class="font-mono text-lg font-bold ${i.stock===0?'text-red-500':(i.stock<i.min?'text-orange-500':'text-slate-700 dark:text-slate-200')}">${i.stock} <span class="text-xs font-sans text-slate-400 font-normal">${i.unit}</span></div>
                         <div class="text-[10px] text-slate-400">Min: ${i.min} | Cost: ${i.cost || 0}‡∏ø</div>
                    </td>
                    <td class="px-6 py-4 text-sm text-slate-500">${i.loc}</td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-2 opacity-100 lg:opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="updateStock(${i.id}, 1)" class="btn-icon bg-green-100 text-green-600 hover:scale-110"><i class="fa-solid fa-plus"></i></button>
                            <button onclick="updateStock(${i.id}, -1)" class="btn-icon bg-red-100 text-red-600 hover:scale-110"><i class="fa-solid fa-minus"></i></button>
                            <span class="w-px h-8 bg-slate-200 mx-1"></span>
                            <button onclick="printLabel(${i.id})" class="btn-icon bg-slate-800 text-white hover:scale-110"><i class="fa-solid fa-print"></i></button>
                            <button onclick="openModal(${i.id})" class="btn-icon bg-blue-100 text-blue-600 hover:scale-110"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="delItem(${i.id})" class="btn-icon bg-slate-100 text-slate-500 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderHistoryTable() {
            const mVal = document.getElementById('hist-month').value;
            const tVal = document.getElementById('hist-type').value;
            const tbody = document.getElementById('hist-body');
            
            let filtered = transactionHistory.filter(t => t.date.startsWith(mVal) && (tVal==='all' || t.type===tVal));
            
            let tin=0, tout=0;
            filtered.forEach(t => { if(t.qty>0) tin+=t.qty; else tout+=Math.abs(t.qty); });
            document.getElementById('sum-in').innerText = tin;
            document.getElementById('sum-out').innerText = tout;

            if(!filtered.length) { tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-slate-400">No records found.</td></tr>`; return; }

            tbody.innerHTML = filtered.map(t => {
                const badge = t.type==='IN'?'bg-green-100 text-green-700':(t.type==='OUT'?'bg-orange-100 text-orange-700':(t.type==='NEW'?'bg-blue-100 text-blue-700':'bg-red-100 text-red-700'));
                return `
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/30">
                    <td class="px-6 py-4"><div class="text-sm font-bold text-slate-700 dark:text-slate-200">${new Date(t.date).toLocaleDateString()}</div><div class="text-xs text-slate-400">${new Date(t.date).toLocaleTimeString()}</div></td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs font-bold ${badge}">${t.type}</span></td>
                    <td class="px-6 py-4"><div class="font-medium text-slate-800 dark:text-white">${t.name}</div><div class="text-xs text-slate-400">${t.sku}</div></td>
                    <td class="px-6 py-4 text-right font-bold font-mono ${t.qty>0?'text-green-600':'text-red-500'}">${t.qty>0?'+':''}${t.qty}</td>
                    <td class="px-6 py-4 text-right text-sm text-slate-500">${t.user}</td>
                </tr>`;
            }).join('');
        }

        // ==========================================
        // 6. ACTIONS (CRUD & LOGIC)
        // ==========================================
        function updateStock(id, amt) {
            const item = inventory.find(i => i.id === id);
            if(!item || (amt < 0 && item.stock <= 0)) return;
            item.stock = Math.max(0, item.stock + amt);
            recordTransaction(amt > 0 ? 'IN' : 'OUT', item, amt);
            save();
            renderInvTable();
            showToast('Stock Updated');
        }

        function delItem(id) {
            if(confirm('Delete item?')) {
                const item = inventory.find(i=>i.id===id);
                if(item) recordTransaction('DELETE', item, 0);
                inventory = inventory.filter(i => i.id !== id);
                save(); renderInvTable(); showToast('Item Deleted');
            }
        }

        function handleFormSubmit() {
            const idVal = document.getElementById('inp-id').value;
            const skuVal = document.getElementById('inp-sku').value.trim();

            if(inventory.some(i => i.sku.toLowerCase() === skuVal.toLowerCase() && i.id.toString() !== idVal)) {
                alert('‚ùå SKU already exists!'); return;
            }

            const newItem = {
                id: idVal ? parseInt(idVal) : Date.now(),
                name: document.getElementById('inp-name').value,
                sku: skuVal,
                stock: parseInt(document.getElementById('inp-stock').value),
                min: parseInt(document.getElementById('inp-min').value),
                unit: document.getElementById('inp-unit').value,
                loc: document.getElementById('inp-loc').value,
                cost: parseFloat(document.getElementById('inp-cost').value) || 0,
                img: document.getElementById('inp-img').value
            };

            if(idVal) {
                const idx = inventory.findIndex(i => i.id === newItem.id);
                const diff = newItem.stock - inventory[idx].stock;
                if(diff !== 0) recordTransaction(diff > 0 ? 'IN' : 'OUT', newItem, diff);
                inventory[idx] = newItem;
            } else {
                inventory.push(newItem);
                recordTransaction('NEW', newItem, newItem.stock);
            }
            save(); closeModal(); renderInvTable(); showToast('Saved Successfully');
        }

        // ==========================================
        // 7. UTILS & EXTRAS
        // ==========================================
        function recordTransaction(type, item, qty) {
            transactionHistory.unshift({ id: Date.now(), date: new Date().toISOString(), type, name: item.name, sku: item.sku, qty, user: currentUser, balance: item.stock });
            if(transactionHistory.length > 1000) transactionHistory.pop();
            activityLogs.unshift({ action: type, desc: `${item.name} (${qty}) by ${currentUser}`, time: new Date().toLocaleTimeString() });
            if(activityLogs.length > 20) activityLogs.pop();
        }
        
        function save() {
            localStorage.setItem('factory_inv_v3', JSON.stringify(inventory));
            localStorage.setItem('factory_logs_v3', JSON.stringify(activityLogs));
            localStorage.setItem('factory_trans_v3', JSON.stringify(transactionHistory));
        }

        function handleBarcodeScan(code) {
            router('inventory');
            document.getElementById('search').value = code;
            renderInvTable();
            const found = inventory.find(i => i.sku.toLowerCase() === code.toLowerCase());
            if(found) { showToast(`Scanned: ${found.name}`); } 
            else { showToast('Item not found', 'error'); }
        }

        function openModal(id = null) {
            document.getElementById('modal-form').classList.remove('hidden');
            if(id) {
                const i = inventory.find(x => x.id === id);
                document.getElementById('modal-title').innerText = 'Edit Item';
                document.getElementById('inp-id').value = i.id;
                document.getElementById('inp-name').value = i.name;
                document.getElementById('inp-sku').value = i.sku;
                document.getElementById('inp-loc').value = i.loc;
                document.getElementById('inp-stock').value = i.stock;
                document.getElementById('inp-min').value = i.min;
                document.getElementById('inp-unit').value = i.unit;
                document.getElementById('inp-cost').value = i.cost;
                document.getElementById('inp-img').value = i.img || '';
            } else {
                document.getElementById('modal-title').innerText = 'Add New Item';
                document.querySelector('form').reset();
                document.getElementById('inp-id').value = '';
            }
            document.getElementById('inp-img').dispatchEvent(new Event('input'));
        }
        function closeModal() { document.getElementById('modal-form').classList.add('hidden'); }

        function openReorderModal() {
            const list = inventory.filter(i => i.stock < i.min);
            const div = document.getElementById('reorder-content');
            if(!list.length) { div.innerHTML = '<p class="text-center text-slate-400 mt-10">All items are sufficiently stocked!</p>'; }
            else {
                let total = 0;
                div.innerHTML = `<table class="w-full text-sm text-left"><thead class="bg-slate-100"><tr><th class="p-3">Item</th><th class="p-3">Current</th><th class="p-3">Order</th><th class="p-3 text-right">Est. Cost</th></tr></thead><tbody>` + 
                list.map(i => {
                    const buy = (i.min - i.stock) + Math.ceil(i.min*0.2);
                    const cost = buy * (i.cost||0);
                    total += cost;
                    return `<tr><td class="p-3"><b>${i.name}</b><div class="text-xs">${i.sku}</div></td><td class="p-3 text-red-600 font-bold">${i.stock}</td><td class="p-3 text-blue-600 font-bold">+${buy}</td><td class="p-3 text-right">${cost.toLocaleString()}‡∏ø</td></tr>`;
                }).join('') + `</tbody><tfoot><tr><td colspan="3" class="p-3 text-right font-bold">Total:</td><td class="p-3 text-right font-bold text-green-600 text-lg">${total.toLocaleString()}‡∏ø</td></tr></tfoot></table>`;
            }
            document.getElementById('modal-reorder').classList.remove('hidden');
        }

        function printLabel(id) {
            const item = inventory.find(i=>i.id===id);
            const area = document.getElementById('print-area');
            area.innerHTML = `<div class="label-card"><div style="flex:1;display:flex;flex-direction:column;justify-content:space-between;"><div><span style="font-size:12px;font-weight:bold">FACTORY ONE</span><h1 style="font-size:22px;font-weight:900;line-height:1.1;margin:5px 0">${item.name}</h1><p style="font-family:monospace;font-size:14px">${item.sku}</p></div><div style="font-size:12px">LOC: <b>${item.loc}</b> | MIN: <b>${item.min}</b></div></div><div style="width:100px;display:flex;flex-direction:column;align-items:center;justify-content:center;"><img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${item.sku}" style="width:100%"><span style="font-size:9px;margin-top:5px">SCAN ME</span></div></div>`;
            area.classList.remove('hidden'); window.print(); area.classList.add('hidden');
        }

        function printReorder() {
            const content = document.getElementById('reorder-content').innerHTML;
            const area = document.getElementById('print-area');
            area.innerHTML = `<div style="padding:40px;font-family:sans-serif"><h1>Purchase Order</h1><p>Date: ${new Date().toLocaleDateString()}</p>${content}</div>`;
            area.classList.remove('hidden'); window.print(); area.classList.add('hidden');
        }

        function backupSystem() {
            const data = { inv: inventory, logs: activityLogs, hist: transactionHistory, ver: '3.0' };
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            a.download = `FactoryOne_Backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); a.remove();
        }

        function restoreSystem(input) {
            const f = input.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                try {
                    const d = JSON.parse(e.target.result);
                    if(d.inv && confirm('Replace current data with backup?')) {
                        localStorage.setItem('factory_inv_v3', JSON.stringify(d.inv));
                        localStorage.setItem('factory_logs_v3', JSON.stringify(d.logs||[]));
                        localStorage.setItem('factory_trans_v3', JSON.stringify(d.hist||[]));
                        location.reload();
                    }
                } catch(err) { alert('Invalid File'); }
            };
            r.readAsText(f);
        }

        function importCSV(input) {
            const f = input.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = e => {
                const lines = e.target.result.split('\n');
                let count = 0;
                for(let i=1; i<lines.length; i++) {
                    const c = lines[i].trim().split(',');
                    if(c.length>=2 && !inventory.some(x=>x.sku===c[1])) {
                        inventory.push({ id: Date.now()+i, name:c[0], sku:c[1], stock:parseInt(c[2])||0, unit:c[3]||'pcs', loc:c[4]||'Gen', min:parseInt(c[5])||10, cost:parseFloat(c[6])||0, img:'' });
                        count++;
                    }
                }
                save(); renderInvTable(); showToast(`Imported ${count} items`); input.value='';
            };
            r.readAsText(f);
        }

        function exportCSV() {
            const csv = "Name,SKU,Stock,Unit,Loc,Min,Cost\n" + inventory.map(i=>`${i.name},${i.sku},${i.stock},${i.unit},${i.loc},${i.min},${i.cost}`).join('\n');
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = 'inventory_export.csv'; a.click();
        }

        function factoryReset() {
            if(confirm('WARNING: Wipe ALL data?')) { localStorage.clear(); location.reload(); }
        }

        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.style.transform = 'translateX(0)'; setTimeout(()=>t.style.transform='translateX(150%)', 2500);
        }

        function statCard(l,v,u,i,c) {
            return `<div class="bg-gradient-to-br from-${c}-500 to-${c}-600 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden group hover:-translate-y-1 transition-transform"><div class="relative z-10"><p class="opacity-80 font-medium text-sm">${l}</p><h3 class="text-3xl font-bold mt-1">${v} <span class="text-sm font-normal opacity-70">${u}</span></h3></div><i class="fa-solid ${i} absolute -bottom-4 -right-4 text-8xl opacity-10 group-hover:scale-110 group-hover:rotate-12 transition-transform"></i></div>`;
        }

        function th(k,l) {
            return `<th onclick="sortConfig.key='${k}';sortConfig.direction=sortConfig.direction==='asc'?'desc':'asc';renderInvTable()" class="px-6 py-4 font-semibold text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider sort-header select-none">${l} <i class="fa-solid fa-sort ml-1 opacity-50"></i></th>`;
        }

        function initCharts() {
            const ctx = document.getElementById('chartInv').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Ok', 'Low', 'Empty'], datasets: [{ data: [inventory.filter(i=>i.stock>=i.min).length, inventory.filter(i=>i.stock<i.min&&i.stock>0).length, inventory.filter(i=>i.stock===0).length], backgroundColor: ['#10b981','#f59e0b','#ef4444'], borderWidth:0 }] }, options: { maintainAspectRatio:false, plugins:{legend:{position:'right'}} } });
        }

        // CSS Helper for button styles
        const style = document.createElement('style');
        style.innerHTML = `.btn-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 12px; }`;
        document.head.appendChild(style);

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', isDarkMode);
            initCharts();
        }

        function toggleSidebar() {
            const s = document.getElementById('sidebar');
            const o = document.getElementById('sidebar-overlay');
            if(s.classList.contains('-translate-x-full')) { s.classList.remove('-translate-x-full'); s.classList.add('translate-x-0'); o.classList.remove('hidden'); }
            else { s.classList.add('-translate-x-full'); s.classList.remove('translate-x-0'); o.classList.add('hidden'); }
        }
    </script>
</body>
</html>
